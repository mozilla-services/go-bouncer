@Library('fxtest@1.1') _

pipeline {
  agent any
  options {
    ansiColor()
    timestamps()
    timeout(time: 5, unit: 'MINUTES')
  }
  environment {
    PYTEST_ADDOPTS = "-n=10 --color=yes"
  }
  stages {
    stage('Lint') {
      steps {
        sh "tox -c tests/e2e/tox.ini -e flake8"
      }
    }
    stage('Test') {
      steps {
        sh "tox -c tests/e2e/tox.ini -e py27"
      }
      post {
        always {
          junit 'tests/e2e/results/*.xml'
          archiveArtifacts 'tests/e2e/results/*'
          step([$class: 'S3BucketPublisher',
            consoleLogLevel: 'INFO',
            dontWaitForConcurrentBuildCompletion: false,
            entries: [[
              bucket: "fx-test-activedata/${BUILD_TAG}",
              excludedFile: '',
              flatten: true,
              gzipFiles: true,
              keepForever: false,
              managedArtifacts: false,
              noUploadOnFailure: false,
              selectedRegion: 'us-east-1',
              showDirectlyInBrowser: false,
              sourceFile: 'tests/e2e/results/py27.log',
              storageClass: 'STANDARD',
              uploadFromSlave: false,
              useServerSideEncryption: false]],
            pluginFailureResultConstraint: 'FAILURE',
            profileName: 'ActiveData',
            userMetadata: []])
        }
      }
    }
  }
  post {
    failure {
      mail(
        body: "${BUILD_URL}",
        from: "firefox-test-engineering@mozilla.com",
        replyTo: "firefox-test-engineering@mozilla.com",
        subject: "Build failed in Jenkins: ${JOB_NAME} #${BUILD_NUMBER}",
        to: "fte-ci@mozilla.com")
    }
    changed {
      ircNotification()
    }
  }
}
